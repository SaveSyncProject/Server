version: '3'

services:

  # Service LDAP
  ldap-server:
    build:
      context: .
      dockerfile_inline: |
        FROM osixia/openldap
    container_name: ldap_server_container
    command: --copy-service
    restart: always

    environment:
      LDAP_ORGANISATION: "CATS"
      LDAP_DOMAIN: "$DOMAINENIV2.$DOMAINENIV1"
      LDAP_ADMIN_PASSWORD: "$LDAP_ADMIN_PASSWORD"
      LDAP_READONLY_USER: true
      LDAP_READONLY_USER_USERNAME: "sysUser"
      LDAP_READONLY_USER_PASSWORD: "readOnlyPassword"
      LDAP_TLS: "false"
      LDAP_TLS_VERIFY_CLIENT: "never"
    ports:
      - "389:389"
    volumes:
      - ./data/ldap_data:/var/lib/ldap
      - ./data/ldap_config:/etc/ldap/slapd.d
      - ./data/ldif:/container/service/slapd/assets/config/bootstrap/ldif/custom

  # Service phpldapadmin
  phpldapadmin:
    image: osixia/phpldapadmin
    container_name: ldap_phpldapadmin_container
    environment:
      PHPLDAPADMIN_LDAP_HOSTS: ldap-server
      PHPLDAPADMIN_HTTPS: 0
    ports:
      - "6080:80"
    depends_on:
      - ldap-server
